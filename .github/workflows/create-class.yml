name: ğŸ§  Create Class Repo Automation

on:
  workflow_dispatch:
    inputs:
      class:
        description: "Enter the class number (5â€“12)"
        required: true
        default: "11"

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ§¹ Clear Cache (Ensure fresh code)
        run: |
          rm -rf ~/.npm ~/.cache
          echo "âœ… Node cache cleared."

      - name: ğŸ§¾ Display Selected Class
        run: echo "ğŸ« Building automation for Class=${{ github.event.inputs.class }}"

      - name: ğŸ§  Run Create Class Script
        run: |
          echo "âš™ï¸ Running createClassRepo.js for class=${{ github.event.inputs.class }}"
          node ./scripts/createClassRepo.js ${{ github.event.inputs.class }}

      - name: âœ… Verify Curriculum.js
        run: |
          echo "ğŸ” Checking curriculum file..."
          if [ -f "./temp_repo/js/curriculum.js" ]; then
            echo "âœ… curriculum.js found and ready."
          else
            echo "âŒ curriculum.js missing â€” check static_curriculum folder."
            exit 1
          fi

      - name: ğŸš€ Push to Class Repository
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          GITHUB_OWNER: ready4exam
          GITHUB_REPO: ready4exam-${{ github.event.inputs.class }}
        run: |
          echo "ğŸ“¤ Deploying to repository: $GITHUB_OWNER/$GITHUB_REPO"
          cd temp_repo
          git init
          git config user.name "ready4exam-automation"
          git config user.email "automation@ready4exam.edu"
          git add .
          git commit -m "Auto-deploy: Class ${{ github.event.inputs.class }} curriculum update"
          git branch -M main
          git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_OWNER}/${GITHUB_REPO}.git
          git push -f origin main
          echo "ğŸ‰ Successfully deployed to: https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}"

      - name: ğŸ Completion Log
        run: echo "âœ… Class ${{ github.event.inputs.class }} automation complete."
