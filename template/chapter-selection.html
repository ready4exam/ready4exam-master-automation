// js/chapter-selection.js
import { curriculum } from "./curriculum.js";

// Detect class and selected stream (for 11/12)
const selectedClass = localStorage.getItem("selectedClass") || "9";
const selectedStream = localStorage.getItem("selectedStream");
const subjectContainer = document.getElementById("subject-list");
const chapterContainer = document.getElementById("chapter-list");
const title = document.getElementById("page-title");

// Utility: clear sections
function clearSection(section) {
  section.innerHTML = "";
}

// üß© Render subjects (5‚Äì10) or streams (11‚Äì12)
function renderSubjects() {
  clearSection(subjectContainer);
  clearSection(chapterContainer);

  if (Number(selectedClass) < 11) {
    // Simple case: list subjects directly from curriculum object
    Object.keys(curriculum).forEach((subjectName) => {
      const btn = document.createElement("button");
      btn.textContent = subjectName;
      btn.className =
        "subject-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 m-2 rounded-lg";
      btn.addEventListener("click", () => renderChapters(subjectName));
      subjectContainer.appendChild(btn);
    });
    title.textContent = `Select Subject for Class ${selectedClass}`;
  } else {
    // Stream-based: Science / Commerce / Humanities
    const streamData = curriculum[selectedStream];
    if (!streamData) {
      subjectContainer.innerHTML = `<p class="text-red-500">‚ö†Ô∏è Stream data not found for ${selectedStream}</p>`;
      return;
    }

    title.textContent = `Select Subject for Class ${selectedClass} (${selectedStream})`;

    streamData.forEach((subject) => {
      const btn = document.createElement("button");
      btn.textContent = subject.subject_name;
      btn.className =
        "subject-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 m-2 rounded-lg";
      btn.addEventListener("click", () => renderBooks(subject));
      subjectContainer.appendChild(btn);
    });
  }
}

// üìö Render books (for Class 11/12)
function renderBooks(subject) {
  clearSection(chapterContainer);
  title.textContent = `Select Book for ${subject.subject_name}`;

  if (!subject.books || subject.books.length === 0) {
    chapterContainer.innerHTML = "<p>No books found for this subject.</p>";
    return;
  }

  subject.books.forEach((book) => {
    const bookBtn = document.createElement("button");
    bookBtn.textContent = book.book_name;
    bookBtn.className =
      "book-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 m-2 rounded-lg";
    bookBtn.addEventListener("click", () =>
      renderChapters(book.chapters, subject.subject_name, book.book_name)
    );
    chapterContainer.appendChild(bookBtn);
  });
}

// üìñ Render chapters (unified for both flows)
function renderChapters(chaptersOrSubject, subjectName = null, bookName = null) {
  clearSection(subjectContainer);
  clearSection(chapterContainer);

  const isArray = Array.isArray(chaptersOrSubject);
  let chapters = [];

  if (isArray) {
    // Case: 11/12 ‚Äî from book
    chapters = chaptersOrSubject;
  } else {
    // Case: ‚â§10 ‚Äî from curriculum[subject]
    chapters =
      curriculum[chaptersOrSubject]?.chapters ||
      curriculum[chaptersOrSubject] ||
      [];
  }

  if (!chapters.length) {
    chapterContainer.innerHTML =
      "<p class='text-gray-500'>No chapters found for this selection.</p>";
    return;
  }

  title.textContent = `Select Chapter ${
    subjectName ? `(${subjectName}${bookName ? " - " + bookName : ""})` : ""
  }`;

  chapters.forEach((ch) => {
    const btn = document.createElement("button");
    const name = ch.chapter_name || ch; // handle both {chapter_name} and string
    btn.textContent = name;
    btn.className =
      "chapter-btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 m-2 rounded-lg";
    btn.addEventListener("click", () => selectDifficulty(name));
    chapterContainer.appendChild(btn);
  });
}

// üéØ Difficulty popup ‚Üí launch quiz
function selectDifficulty(chapterName) {
  const difficulty = prompt(
    `Select difficulty for "${chapterName}" (easy / medium / hard):`,
    "easy"
  );
  if (!difficulty) return;

  localStorage.setItem("selectedChapter", chapterName);
  localStorage.setItem("selectedDifficulty", difficulty);
  window.location.href = "quiz-engine.html";
}

// Run
document.addEventListener("DOMContentLoaded", renderSubjects);
