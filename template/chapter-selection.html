<script type="module">
  import { curriculum } from './js/curriculum.js';
  const dynamicContainer = document.getElementById('dynamic-container');
  const difficultyContainer = document.getElementById('difficulty-container');
  const startQuizBtn = document.getElementById('start-quiz-btn');
  const selectedChapterDisplay = document.getElementById('selected-chapter-display');
  const errorMessageEl = document.getElementById('error-message');
  const pageTitle = document.getElementById('page-title');
  const difficultyBtns = document.querySelectorAll('.difficulty-btn');

  let selectedClass = localStorage.getItem('selectedClass') || '9';
  let selectedStream = localStorage.getItem('selectedStream') || null;
  let selectedSubject = null;
  let selectedBook = null;
  let selectedChapter = null;
  let selectedDifficulty = null;

  /*** CLASS <= 10 â€” Classic flow (no changes) ***/
  function renderClassicSubjects() {
    dynamicContainer.innerHTML = '';
    pageTitle.textContent = `Select Subject for Class ${selectedClass}`;
    const subjects = Object.keys(curriculum[selectedClass] || {});
    if (!subjects.length) {
      dynamicContainer.innerHTML = '<p class="text-red-500">No subjects found.</p>';
      return;
    }

    subjects.forEach(subject => {
      const btn = document.createElement('button');
      btn.textContent = subject.replace(/_/g, ' ');
      btn.className = 'bg-blue-500 text-white font-semibold px-6 py-3 rounded-xl shadow hover:bg-blue-600 m-2';
      btn.onclick = () => renderClassicChapters(subject);
      dynamicContainer.appendChild(btn);
    });
  }

  function renderClassicChapters(subject) {
    dynamicContainer.innerHTML = '';
    pageTitle.textContent = `${subject.replace(/_/g, ' ')} - Select Chapter`;
    const chapters = curriculum[selectedClass]?.[subject] || [];
    if (!chapters.length) {
      dynamicContainer.innerHTML = '<p class="text-gray-500">No chapters available.</p>';
      return;
    }
    chapters.forEach(ch => {
      const btn = document.createElement('button');
      btn.className = 'topic-btn w-full text-left';
      btn.innerHTML = `<span>${ch.title || ch}</span><i data-lucide="chevron-right" class="w-5 h-5 text-cbse-blue"></i>`;
      btn.onclick = (e) => selectChapter(ch.title || ch, e.currentTarget);
      dynamicContainer.appendChild(btn);
    });
    lucide.createIcons();
  }

  /*** CLASS 11â€“12 â€” Stream-based subjects ***/
  function renderStreamSubjects() {
    dynamicContainer.innerHTML = '';
    pageTitle.textContent = `Select Subject (${selectedStream})`;

    // ðŸŽ¯ Stream-wise subject mapping
    const STREAM_SUBJECTS = {
      Science: ['Physics', 'Chemistry', 'Biology', 'Mathematics'],
      Commerce: ['Accountancy', 'Business Studies', 'Economics', 'Mathematics'],
      Humanities: [
        'History',
        'Geography',
        'Political Science',
        'Sociology',
        'Psychology',
        'Economics',
        'English'
      ]
    };

    const allowedSubjects = STREAM_SUBJECTS[selectedStream] || [];
    const allSubjects = Object.keys(curriculum);

    const streamSubjects = allSubjects.filter(s => allowedSubjects.includes(s));

    if (!streamSubjects.length) {
      dynamicContainer.innerHTML = `<p class="text-red-500 text-center">No subjects found for ${selectedStream}.</p>`;
      return;
    }

    streamSubjects.forEach(subject => {
      const btn = document.createElement('button');
      btn.textContent = subject;
      btn.className = 'bg-blue-500 text-white font-semibold px-6 py-3 rounded-xl shadow hover:bg-blue-600 m-2';
      btn.onclick = () => renderBooks(curriculum[subject], subject);
      dynamicContainer.appendChild(btn);
    });
  }

  function renderBooks(subjectObj, subjectName) {
    selectedSubject = subjectName;
    dynamicContainer.innerHTML = '';
    pageTitle.textContent = `Select Book (${subjectName})`;
    const books = Object.keys(subjectObj || {});
    if (!books.length) {
      dynamicContainer.innerHTML = '<p>No books found.</p>';
      return;
    }
    books.forEach(book => {
      const btn = document.createElement('button');
      btn.textContent = book;
      btn.className = 'bg-green-500 text-white font-semibold px-6 py-3 rounded-xl shadow hover:bg-green-600 m-2';
      btn.onclick = () => renderChapters(subjectObj[book], book);
      dynamicContainer.appendChild(btn);
    });
  }

  function renderChapters(chapterList, bookName) {
    selectedBook = bookName;
    dynamicContainer.innerHTML = '';
    pageTitle.textContent = `Select Chapter (${bookName})`;
    if (!chapterList?.length) {
      dynamicContainer.innerHTML = '<p>No chapters found.</p>';
      return;
    }
    chapterList.forEach(chapter => {
      const btn = document.createElement('button');
      btn.textContent = chapter;
      btn.className = 'topic-btn w-full text-left';
      btn.onclick = (e) => selectChapter(chapter, e.currentTarget);
      dynamicContainer.appendChild(btn);
    });
    lucide.createIcons();
  }

  /*** Shared chapter + difficulty logic ***/
  function selectChapter(chapterName, element) {
    selectedChapter = chapterName;
    selectedChapterDisplay.textContent = `Selected Chapter: ${chapterName}`;
    selectedChapterDisplay.classList.remove('hidden');
    difficultyContainer.classList.remove('hidden');
    startQuizBtn.disabled = true;
    errorMessageEl.classList.add('hidden');
    document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('selected'));
    element.classList.add('selected');
  }

  difficultyBtns.forEach(btn => {
    btn.addEventListener('click', e => {
      selectedDifficulty = e.target.dataset.difficulty;
      difficultyBtns.forEach(b => b.classList.remove('selected'));
      e.target.classList.add('selected');
      startQuizBtn.disabled = !selectedChapter;
    });
  });

  startQuizBtn.onclick = () => {
    if (!selectedChapter || !selectedDifficulty) {
      errorMessageEl.classList.remove('hidden');
      return;
    }
    localStorage.setItem('selectedChapter', selectedChapter);
    localStorage.setItem('selectedDifficulty', selectedDifficulty);
    localStorage.setItem('selectedSubject', selectedSubject || '');
    localStorage.setItem('selectedBook', selectedBook || '');
    window.location.href = 'quiz-engine.html';
  };

  /*** INIT ***/
  document.addEventListener('DOMContentLoaded', () => {
    if (Number(selectedClass) >= 11) {
      renderStreamSubjects();
    } else {
      renderClassicSubjects();
    }
  });
</script>
